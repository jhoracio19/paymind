{% extends 'base.html' %}

{% block content %}
<div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-6">
    <h1 class="text-2xl font-semibold text-slate-900">
        Dashboard de tarjetas
    </h1>
    <a href="{% url 'card_create' %}"
       class="inline-flex items-center justify-center gap-1 text-sm px-4 py-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm w-full sm:w-auto">
        <span>‚ûï</span>
        <span>Agregar tarjeta</span>
    </a>
</div>

{% if notificaciones %}
    <div class="mb-4 space-y-2">
        {% for n in notificaciones %}
            <div class="rounded-2xl border border-amber-100 bg-amber-50 px-4 py-3 flex items-start gap-3 text-sm">
                <div class="mt-0.5">
                    <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-amber-100 text-amber-600 text-xs font-semibold">
                        !
                    </span>
                </div>
                <div class="flex-1">
                    <p class="font-semibold text-amber-800">
                        Recordatorio de {{ n.card.banco }} ‚Äì {{ n.card.nombre }}
                    </p>
                    <p class="text-amber-800/90 mt-0.5">
                        {{ n.mensaje }}
                    </p>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- Pagos pendientes (fechas de pago pasadas) -->
{% if pagos_pendientes %}
<section class="mb-6">
    <div class="bg-gradient-to-br from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 rounded-2xl border-2 border-red-200 dark:border-red-800/50 shadow-lg p-4 sm:p-6">
        <div class="flex items-center gap-3 mb-4">
            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/50 flex items-center justify-center">
                <span class="text-xl">‚ö†Ô∏è</span>
            </div>
            <div>
                <h2 class="text-base sm:text-lg font-bold text-red-800 dark:text-red-300">
                    Pagos Pendientes
                </h2>
                <p class="text-xs sm:text-sm text-red-600 dark:text-red-400">
                    Marca como pagado cuando hayas realizado el pago
                </p>
            </div>
        </div>
        
        <div class="space-y-3">
            {% for pago in pagos_pendientes %}
            <div class="bg-white dark:bg-slate-800 rounded-xl border border-red-200 dark:border-red-800/50 p-4 shadow-sm hover:shadow-md transition-all duration-200" data-pago-id="{{ pago.historial_id }}">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="inline-block w-2 h-8 rounded-full" style="background-color: {{ pago.card.color }}"></span>
                            <div>
                                <p class="font-semibold text-slate-900 dark:text-slate-100">
                                    {{ pago.card.banco }} ‚Äì {{ pago.card.nombre }}
                                </p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">
                                    Fecha l√≠mite: {{ pago.fecha_pago|date:"j \\d\\e F \\d\\e Y" }}
                                </p>
                            </div>
                        </div>
                        <div class="ml-5">
                            <p class="text-sm text-slate-600 dark:text-slate-400">
                                Saldo pendiente:
                                <span class="font-bold text-red-600 dark:text-red-400 text-lg">
                                    ${{ pago.saldo|floatformat:2 }}
                                </span>
                            </p>
                        </div>
                    </div>
                    <button 
                        type="button"
                        onclick="marcarPagoCompletado({{ pago.historial_id }})"
                        class="inline-flex items-center gap-2 px-4 py-2.5 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold text-sm shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        id="btn-pago-{{ pago.historial_id }}">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Marcar como pagado</span>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>
{% endif %}

{% if cards %}

<!-- Resumen global -->
<section class="mb-6">
    <div id="resumen-global"
         class="bg-white rounded-2xl shadow-sm border border-slate-100 p-5 flex flex-col gap-4"
         data-total-limite="0"
         data-total-saldo="0">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div>
                <h2 class="text-sm font-semibold text-slate-700 uppercase tracking-wide">
                    Resumen general
                </h2>
                <p class="text-xs text-slate-500">
                    Visi√≥n r√°pida de tu uso total de cr√©dito.
                </p>
            </div>
            <p class="text-xs text-slate-500">
                Datos calculados autom√°ticamente seg√∫n tus tarjetas activas.
            </p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">L√≠mite total</p>
                <p class="text-lg font-semibold text-slate-900" id="resumen-limite">$0.00</p>
            </div>
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">Saldo total</p>
                <p class="text-lg font-semibold" id="resumen-saldo">$0.00</p>
            </div>
            <div>
                <p class="text-xs text-slate-500 uppercase tracking-wide">% de uso</p>
                <p class="text-lg font-semibold text-slate-900" id="resumen-porcentaje">0%</p>
            </div>
        </div>
        <div>
            <div class="h-2 w-full rounded-full bg-slate-100 overflow-hidden">
                <div id="resumen-barra"
                     class="h-2 rounded-full bg-indigo-500 transition-all duration-300"
                     style="width: 0%;">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Gr√°fico de dona - Cr√©dito total -->
{% if chart_data %}
<section class="mb-6">
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-200 dark:border-slate-700 p-4 sm:p-6 transition-all duration-300 hover:shadow-xl">
        <div class="mb-4 sm:mb-6">
            <h2 class="text-base sm:text-lg font-bold text-slate-800 dark:text-slate-100 mb-2 flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 text-white text-sm font-semibold shadow-md">
                    üìä
                </span>
                Distribuci√≥n de cr√©dito total
            </h2>
            <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">
                Visualizaci√≥n del cr√©dito total distribuido entre tus tarjetas.
            </p>
        </div>
        
        <div class="flex flex-col lg:flex-row items-center justify-center gap-4 sm:gap-6 lg:gap-8">
            <!-- Gr√°fico -->
            <div class="w-full sm:w-72 lg:w-80 h-64 sm:h-72 lg:h-80 flex items-center justify-center relative group">
                <div class="absolute inset-0 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/20 dark:to-purple-900/20 rounded-2xl blur-xl opacity-50 group-hover:opacity-75 transition-opacity duration-300"></div>
                <div class="relative w-full h-full flex items-center justify-center">
                    <canvas id="creditoDonaChart" class="drop-shadow-lg"></canvas>
                </div>
            </div>
            
            <!-- Informaci√≥n y leyenda -->
            <div class="flex-1 w-full lg:w-auto">
                <div class="space-y-4">
                    <!-- Total de cr√©dito -->
                    <div class="text-center lg:text-left bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-900/30 dark:to-purple-900/30 rounded-xl p-4 border border-indigo-100 dark:border-indigo-800/50">
                        <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 uppercase tracking-wide mb-1 font-medium">
                            Cr√©dito total
                        </p>
                        <p class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 dark:from-indigo-400 dark:to-purple-400 bg-clip-text text-transparent" id="total-credito-display">
                            ${{ total_credito|floatformat:2 }}
                        </p>
                    </div>
                    
                    <!-- Leyenda de tarjetas -->
                    <div class="space-y-2 max-h-48 sm:max-h-56 overflow-y-auto custom-scrollbar">
                        <p class="text-xs font-semibold text-slate-600 dark:text-slate-400 uppercase tracking-wide mb-2">
                            Por tarjeta:
                        </p>
                        {% for item in chart_data %}
                        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors duration-200 group">
                            <span class="inline-block w-4 h-4 rounded-full shadow-sm group-hover:scale-110 transition-transform duration-200" style="background-color: {{ item.color }};"></span>
                            <span class="text-sm text-slate-700 dark:text-slate-300 flex-1 truncate">{{ item.label }}</span>
                            <span class="font-semibold text-slate-900 dark:text-slate-100 text-sm">${{ item.value|floatformat:2 }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-track {
        background: #1e293b;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #475569;
    }
    .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #64748b;
    }
</style>
{% endif %}

<!-- Resumen principal -->
<div class="grid gap-4 grid-cols-1 md:grid-cols-2 mb-8">

    <!-- Pr√≥xima tarjeta -->
    <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
        <div class="flex items-center gap-3 mb-3">
            <div class="bg-indigo-100 text-indigo-600 p-2 rounded-lg">
                <i data-feather="alert-circle" class="w-5 h-5"></i>
            </div>
            <h2 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">
                Pr√≥xima tarjeta a pagar
            </h2>
        </div>

        {% if next_to_pay %}
        <div class="mt-2 space-y-1.5">
            <div class="flex items-center gap-2">
                <span class="inline-block w-1.5 h-8 rounded-full" style="background-color: {{ next_to_pay.color }}"></span>
                <p class="text-lg font-semibold text-slate-900">
                    {{ next_to_pay.banco }} ‚Äì {{ next_to_pay.nombre }}
                </p>
            </div>
            <p class="text-sm text-slate-600">
                Fecha l√≠mite real:
                <span class="font-semibold">
                    {{ next_to_pay.proxima_fecha_limite_real|date:"j \\d\\e F \\d\\e Y" }}
                </span>
            </p>
            <p class="text-sm text-slate-600">
                Saldo pendiente:
                <span class="font-semibold text-red-500">
                    ${{ next_to_pay.saldo_actual }}
                </span>
            </p>
        </div>
        {% else %}
            <p class="text-sm text-slate-500">No hay tarjetas registradas.</p>
        {% endif %}
    </div>

    <!-- Tarjeta recomendada -->
    <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
        <div class="flex items-center gap-3 mb-3">
            <div class="bg-green-100 text-green-600 p-2 rounded-lg">
                <i data-feather="thumbs-up" class="w-5 h-5"></i>
            </div>
            <h2 class="text-sm font-semibold text-slate-600 uppercase tracking-wide">
                Tarjeta recomendada para usar hoy
            </h2>
        </div>

        {% if recommended_card %}
        <div class="mt-2 space-y-1.5">
            <div class="flex items-center gap-2">
                <span class="inline-block w-1.5 h-8 rounded-full" style="background-color: {{ recommended_card.color }}"></span>
                <p class="text-lg font-semibold text-slate-900">
                    {{ recommended_card.banco }} ‚Äì {{ recommended_card.nombre }}
                </p>
            </div>
            <p class="text-sm text-slate-600">
                Pr√≥xima fecha de corte:
                <span class="font-semibold">
                    {{ recommended_card.proxima_fecha_corte_real|date:"j \\d\\e F \\d\\e Y" }}
                </span>
            </p>
            <p class="text-sm text-slate-600">
                L√≠mite disponible:
                <span class="font-semibold">
                    ${{ recommended_card.limite_credito }}
                </span>
            </p>
        </div>
        {% else %}
            <p class="text-sm text-slate-500">Agrega una tarjeta para ver la recomendaci√≥n.</p>
        {% endif %}
    </div>

</div>

    </div>

    <!-- Lista de tarjetas -->
    <div class="space-y-4">
        {% for card in cards %}
            <div class="bg-white rounded-2xl border border-slate-100 p-4 flex flex-col gap-4 shadow-sm hover:shadow-md transition"
                 data-card-limite="{{ card.limite_credito }}"
                 data-card-saldo="{{ card.saldo_actual }}">

                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">

                    <!-- Info principal -->
                    <div class="flex-1 flex gap-3">
                        <div class="w-1.5 rounded-full" style="background-color: {{ card.color }}"></div>
                        <div class="space-y-1">
                            <p class="text-sm text-gray-500">
                                {{ card.banco }}
                            </p>
                            <p class="text-lg font-semibold text-slate-900">
                                {{ card.nombre }}
                            </p>
                            <p class="text-xs text-slate-500">
                                Pr√≥xima fecha l√≠mite:
                                <span class="font-medium">
                                    {{ card.proxima_fecha_limite_real|date:"j \\d\\e F \\d\\e Y" }}
                                </span>
                            </p>
                            <div class="flex flex-wrap gap-x-4 gap-y-1 text-[11px] text-slate-500">
                                <span>Corte: d√≠a {{ card.dia_corte }}</span>
                                <span>Pago l√≠mite: d√≠a {{ card.dia_limite_pago }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Importes -->
                    <div class="text-sm text-slate-700 md:text-right space-y-1">
                        <p>
                            <span class="text-xs text-slate-500 uppercase tracking-wide">L√≠mite</span><br>
                            <span class="font-semibold">
                                ${{ card.limite_credito }}
                            </span>
                        </p>
                        <p>
                            <span class="text-xs text-slate-500 uppercase tracking-wide">Saldo</span><br>
                            <span class="font-semibold {% if card.saldo_actual > 0 %}text-red-500{% else %}text-emerald-600{% endif %}">
                                ${{ card.saldo_actual }}
                            </span>
                        </p>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="flex flex-wrap items-center justify-end gap-3 text-sm pt-1 border-t border-slate-100 pt-3">
                    {% if card.saldo_actual > 0 %}
                    <button 
                        type="button"
                        onclick="marcarPagoTarjeta({{ card.pk }})"
                        class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold text-sm shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        id="btn-pago-tarjeta-{{ card.pk }}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Marcar pago</span>
                    </button>
                    {% endif %}
                    <a href="{% url 'card_update' card.pk %}"
                       class="text-indigo-600 hover:text-indigo-700 font-medium">
                        Editar
                    </a>
                    <a href="{% url 'card_delete' card.pk %}"
                       class="text-red-500 hover:text-red-600 font-medium">
                        Eliminar
                    </a>
                </div>

            </div>
        {% endfor %}
    </div>


    <!-- Calendario agrupado por mes -->
    <section class="mt-8">
        <h2 class="text-lg font-semibold text-slate-900 mb-3">
            Calendario de cortes y pagos
        </h2>

        {% if eventos %}
        <div class="bg-white rounded-2xl border border-slate-100 p-5 shadow-sm">
            <p class="text-xs text-slate-500 mb-4">
                Eventos ordenados por fecha, agrupados por mes.
            </p>
            <div class="space-y-4 text-sm">
                {% for e in eventos %}
                    {% ifchanged e.fecha|date:"F Y" %}
                        <h3 class="text-xs font-semibold tracking-wide text-slate-500 uppercase mt-2">
                            {{ e.fecha|date:"F Y" }}
                        </h3>
                    {% endifchanged %}
                    <div class="flex items-center justify-between border-b border-slate-100 py-2 last:border-b-0">
                        <div class="space-y-0.5">
                            <p class="font-medium text-slate-800">
                                {{ e.fecha|date:"j \\d\\e F \\d\\e Y" }}
                            </p>
                            <p class="text-xs text-slate-500">
                                {{ e.card.banco }} ‚Äì {{ e.card.nombre }}
                            </p>
                        </div>
                        <span class="inline-flex items-center px-3 py-0.5 rounded-full text-xs font-semibold
                                     {% if e.tipo == 'Pago' %}
                                        bg-emerald-100 text-emerald-700
                                     {% else %}
                                        bg-gray-100 text-gray-700
                                     {% endif %}">
                            {{ e.tipo }}
                        </span>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
            <p class="text-sm text-slate-500">No hay eventos.</p>
        {% endif %}
    </section>


{% else %}
    <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 p-4 rounded-lg mb-4">
        <p class="font-medium">A√∫n no has registrado ninguna tarjeta.</p>
        <p class="text-sm mt-1">Comienza agregando tu primera tarjeta para activar tu dashboard financiero.</p>
    </div>

    <a href="{% url 'card_create' %}"
        class="inline-flex items-center gap-1 text-sm px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
        <span>‚ûï</span>
        <span>Agregar tarjeta</span>
    </a>
{% endif %}


<script>
    // C√°lculo en cliente del resumen global (no toca el backend)
    (function () {
        const resumen = document.getElementById('resumen-global');
        if (!resumen) return;

        const cards = document.querySelectorAll('[data-card-limite]');
        let totalLimite = 0;
        let totalSaldo = 0;

        cards.forEach(card => {
            const limite = parseFloat(card.dataset.cardLimite || '0') || 0;
            const saldo = parseFloat(card.dataset.cardSaldo || '0') || 0;
            totalLimite += limite;
            totalSaldo += saldo;
        });

        const formatCurrency = (v) =>
            new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', maximumFractionDigits: 2 }).format(v);

        const pct = totalLimite > 0 ? Math.min(100, Math.round((totalSaldo / totalLimite) * 100)) : 0;

        document.getElementById('resumen-limite').textContent = formatCurrency(totalLimite);
        const saldoEl = document.getElementById('resumen-saldo');
        saldoEl.textContent = formatCurrency(totalSaldo);
        saldoEl.classList.toggle('text-red-600', totalSaldo > 0);
        saldoEl.classList.toggle('text-emerald-600', totalSaldo === 0);

        document.getElementById('resumen-porcentaje').textContent = pct + '%';
        document.getElementById('resumen-barra').style.width = pct + '%';
    })();

    // Gr√°fico de dona - Cr√©dito total (responsive y moderno)
    {% if chart_data %}
    (function () {
        const ctx = document.getElementById('creditoDonaChart');
        if (!ctx) return;

        const chartData = [
            {% for item in chart_data %}
            {
                label: '{{ item.label|escapejs }}',
                value: {{ item.value }},
                color: '{{ item.color }}'
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Funci√≥n para obtener el tama√±o responsive
        const getResponsiveSize = () => {
            const width = window.innerWidth;
            if (width < 640) return 200; // mobile
            if (width < 1024) return 250; // tablet
            return 280; // desktop
        };

        // Crear el gr√°fico
        const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: chartData.map(item => item.label),
                datasets: [{
                    data: chartData.map(item => item.value),
                    backgroundColor: chartData.map(item => item.color),
                    borderWidth: 3,
                    borderColor: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#1e293b' : '#ffffff',
                    hoverBorderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                animation: {
                    animateRotate: true,
                    animateScale: true,
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        borderColor: 'rgba(99, 102, 241, 0.5)',
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': $' + value.toLocaleString('es-MX', {
                                    minimumFractionDigits: 2,
                                    maximumFractionDigits: 2
                                }) + ' (' + percentage + '%)';
                            }
                        }
                    }
                },
                cutout: '65%',
                onHover: (event, activeElements) => {
                    ctx.style.cursor = activeElements.length > 0 ? 'pointer' : 'default';
                }
            }
        });

        // Redimensionar el gr√°fico en cambios de ventana
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                chart.resize();
            }, 250);
        });
    })();
    {% endif %}

    // Funci√≥n para marcar pagos como completados
    function marcarPagoCompletado(historialId) {
        const btn = document.getElementById(`btn-pago-${historialId}`);
        const cardElement = document.querySelector(`[data-pago-id="${historialId}"]`);
        
        if (!btn || btn.disabled) return;
        
        // Deshabilitar bot√≥n y mostrar loading
        btn.disabled = true;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Procesando...</span>';
        
        // Obtener token CSRF
        const csrftoken = getCookie('csrftoken');
        
        // Hacer la petici√≥n AJAX
        fetch(`/cards/pagos/${historialId}/marcar-pagado/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar animaci√≥n de √©xito
                cardElement.style.transition = 'all 0.5s ease-out';
                cardElement.style.opacity = '0.5';
                cardElement.style.transform = 'scale(0.95)';
                
                // Cambiar el contenido del card a estado de completado
                setTimeout(() => {
                    cardElement.innerHTML = `
                        <div class="flex items-center gap-3 p-4">
                            <div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/50 flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-green-700 dark:text-green-400">‚úì Pago completado</p>
                                <p class="text-sm text-green-600 dark:text-green-500">${data.message}</p>
                            </div>
                        </div>
                    `;
                    
                    // Recargar la p√°gina despu√©s de 1.5 segundos para actualizar los datos
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }, 300);
            } else {
                // Mostrar error
                alert(data.message || 'Error al marcar el pago como completado');
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud. Por favor, intenta de nuevo.');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        });
    }
    
    // Funci√≥n auxiliar para obtener cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Funci√≥n para marcar el pago de una tarjeta directamente
    function marcarPagoTarjeta(cardId) {
        const btn = document.getElementById(`btn-pago-tarjeta-${cardId}`);
        const cardElement = document.querySelector(`[data-card-saldo]`);
        
        if (!btn || btn.disabled) return;
        
        // Confirmar acci√≥n
        if (!confirm('¬øEst√°s seguro de que deseas marcar este pago como completado? El saldo se resetear√° a $0.')) {
            return;
        }
        
        // Deshabilitar bot√≥n y mostrar loading
        btn.disabled = true;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>Procesando...</span>';
        
        // Obtener token CSRF
        const csrftoken = getCookie('csrftoken');
        
        // Hacer la petici√≥n AJAX
        fetch(`/cards/${cardId}/marcar-pago/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de √©xito
                const successMessage = document.createElement('div');
                successMessage.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2';
                successMessage.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>${data.message}</span>
                `;
                document.body.appendChild(successMessage);
                
                // Redirigir al historial despu√©s de 1.5 segundos
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/historial/';
                }, 1500);
            } else {
                // Mostrar error
                alert(data.message || 'Error al marcar el pago como completado');
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud. Por favor, intenta de nuevo.');
            btn.disabled = false;
            btn.innerHTML = originalHTML;
        });
    }
</script>

{% endblock %}
