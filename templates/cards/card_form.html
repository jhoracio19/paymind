{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}

<div class="max-w-xl mx-auto">
    <!-- Título -->
    <h1 class="text-2xl font-bold text-slate-900 mb-4 text-left">
        {{ title }}
    </h1>

    <!-- Contenedor principal, pensado primero para móvil -->
    <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-5 sm:p-6 space-y-5">

        <!-- Vista previa de la tarjeta -->
        <div class="flex justify-center">
            <div id="card-preview"
                 class="w-full max-w-sm rounded-2xl p-4 sm:p-5 text-white shadow-lg transition-all duration-200"
                 style="background: #4F46E5;">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <p class="text-xs uppercase tracking-wide text-slate-100/80">Banco</p>
                        <p id="preview-banco" class="text-base font-semibold">
                            {{ form.banco.value|default:"Nombre del banco" }}
                        </p>
                    </div>
                    <span class="text-xs bg-white/20 px-2 py-1 rounded-full backdrop-blur">
                        PayMind
                    </span>
                </div>

                <div class="mb-4">
                    <p class="text-[11px] uppercase tracking-wide text-slate-100/80">Nombre en la tarjeta</p>
                    <p id="preview-nombre" class="text-sm font-medium">
                        {{ form.nombre.value|default:"Nombre de la tarjeta" }}
                    </p>
                </div>

                <div class="flex items-end justify-between text-[11px] text-slate-100/80">
                    <div>
                        <p class="uppercase tracking-wide">Límite</p>
                        <p id="preview-limite" class="text-sm font-semibold">
                            {% if form.limite_credito.value %}
                                ${{ form.limite_credito.value }}
                            {% else %}
                                $0.00
                            {% endif %}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="uppercase tracking-wide">Día de corte</p>
                        <p id="preview-diacorte" class="text-sm font-semibold">
                            {{ form.dia_corte.value|default:"--" }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario -->
        <form method="post" class="space-y-4">
            {% csrf_token %}

            {% if form.errors %}
                <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
                    <p class="font-semibold mb-1">
                        Revisa los datos de la tarjeta:
                    </p>
                    <ul class="list-disc pl-5 space-y-0.5">
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li><span class="font-medium">{{ field.label }}:</span> {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            {% for field in form %}
                {% if field.name == "color" %}
                    <!-- Campo de color con paleta visual -->
                    <div class="space-y-3">
                        <label class="block text-sm font-medium text-slate-700">
                            Color de la tarjeta
                        </label>
                        
                        <!-- Paleta de colores predefinidos -->
                        <div class="space-y-2">
                            <p class="text-xs text-slate-500 mb-2">Colores sugeridos:</p>
                            <div class="grid grid-cols-8 sm:grid-cols-10 gap-2" id="color-palette">
                                <!-- Colores predefinidos comunes para tarjetas -->
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#4F46E5" style="background-color: #4F46E5;" title="Azul índigo"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#EF4444" style="background-color: #EF4444;" title="Rojo"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#10B981" style="background-color: #10B981;" title="Verde"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#F59E0B" style="background-color: #F59E0B;" title="Ámbar"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#8B5CF6" style="background-color: #8B5CF6;" title="Púrpura"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#EC4899" style="background-color: #EC4899;" title="Rosa"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#06B6D4" style="background-color: #06B6D4;" title="Cian"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#F97316" style="background-color: #F97316;" title="Naranja"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#84CC16" style="background-color: #84CC16;" title="Lima"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#6366F1" style="background-color: #6366F1;" title="Índigo"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#DC2626" style="background-color: #DC2626;" title="Rojo oscuro"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#059669" style="background-color: #059669;" title="Verde esmeralda"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#D97706" style="background-color: #D97706;" title="Ámbar oscuro"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#7C3AED" style="background-color: #7C3AED;" title="Violeta"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#DB2777" style="background-color: #DB2777;" title="Rosa fucsia"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#0891B2" style="background-color: #0891B2;" title="Cian oscuro"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#EA580C" style="background-color: #EA580C;" title="Naranja oscuro"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#65A30D" style="background-color: #65A30D;" title="Lima oscuro"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#1E40AF" style="background-color: #1E40AF;" title="Azul"></button>
                                <button type="button" class="color-option w-10 h-10 rounded-lg border-2 border-slate-200 hover:border-indigo-500 hover:scale-110 transition-all cursor-pointer" data-color="#991B1B" style="background-color: #991B1B;" title="Rojo muy oscuro"></button>
                            </div>
                        </div>
                        
                        <!-- Selector de color personalizado -->
                        <div class="flex items-center gap-3">
                            <div class="flex-1">
                                <p class="text-xs text-slate-500 mb-2">O elige un color personalizado:</p>
                                <div class="flex items-center gap-3">
                                    {{ field|add_class:"w-20 h-12 rounded-lg border-2 border-slate-300 cursor-pointer" }}
                                    <div class="flex-1">
                                        <input type="text" id="color-hex-display" readonly 
                                               class="w-full px-3 py-2 rounded-lg border border-slate-300 text-sm bg-slate-50 text-slate-700 font-mono"
                                               placeholder="#000000">
                                        <p class="text-xs text-slate-400 mt-1">Código HEX del color seleccionado</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% if field.errors %}
                            <p class="text-xs text-red-500">
                                {{ field.errors }}
                            </p>
                        {% endif %}
                    </div>
                {% else %}
                    <div class="space-y-1">
                        <label class="block text-sm font-medium text-slate-700">
                            {{ field.label }}
                        </label>
                        {{ field|add_class:"w-full rounded-xl border border-gray-200 px-3 py-2.5 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" }}
                        {% if field.help_text %}
                            <p class="text-xs text-slate-400">{{ field.help_text }}</p>
                        {% endif %}
                        {% if field.errors %}
                            <p class="text-xs text-red-500">
                                {{ field.errors }}
                            </p>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <!-- Botones de acción -->
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-end gap-3 pt-2">
                <a href="{% url 'cards_list' %}"
                   class="w-full sm:w-auto inline-flex justify-center px-4 py-2.5 rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 text-sm font-medium transition-colors">
                    Cancelar
                </a>

                <button type="submit"
                        class="w-full sm:w-auto inline-flex justify-center px-4 py-2.5 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 text-sm font-semibold shadow-sm transition-colors">
                    Guardar tarjeta
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Script para sincronizar el color, paleta y vista previa -->
<script>
    (function () {
        const colorInput = document.querySelector('input[name="color"]');
        const colorHexDisplay = document.getElementById('color-hex-display');
        const cardPreview = document.getElementById('card-preview');
        const colorOptions = document.querySelectorAll('.color-option');

        const bancoInput = document.querySelector('input[name="banco"]');
        const nombreInput = document.querySelector('input[name="nombre"]');
        const limiteInput = document.querySelector('input[name="limite_credito"]');
        const diaCorteInput = document.querySelector('input[name="dia_corte"]');

        const bancoText = document.getElementById('preview-banco');
        const nombreText = document.getElementById('preview-nombre');
        const limiteText = document.getElementById('preview-limite');
        const diaCorteText = document.getElementById('preview-diacorte');

        // Función para actualizar el color en todos los lugares
        const updateColor = (colorValue) => {
            if (!colorValue) return;
            
            // Actualizar el input de color
            if (colorInput) {
                colorInput.value = colorValue;
            }
            
            // Actualizar el display del código HEX
            if (colorHexDisplay) {
                colorHexDisplay.value = colorValue.toUpperCase();
            }
            
            // Actualizar la vista previa de la tarjeta
            if (cardPreview) {
                cardPreview.style.background = colorValue;
            }
            
            // Actualizar el estado visual de los botones de la paleta
            colorOptions.forEach(btn => {
                const btnColor = btn.dataset.color;
                if (btnColor && btnColor.toUpperCase() === colorValue.toUpperCase()) {
                    btn.classList.add('ring-2', 'ring-indigo-500', 'ring-offset-2');
                    btn.classList.remove('border-slate-200');
                    btn.style.borderColor = '#6366F1';
                } else {
                    btn.classList.remove('ring-2', 'ring-indigo-500', 'ring-offset-2');
                    btn.classList.add('border-slate-200');
                    btn.style.borderColor = '';
                }
            });
        };

        // Inicializar con el valor por defecto o el valor existente
        if (colorInput) {
            const initialColor = colorInput.value || '#4F46E5';
            updateColor(initialColor);
            
            // Escuchar cambios en el selector de color nativo
            colorInput.addEventListener('input', (e) => {
                updateColor(e.target.value);
            });
        }

        // Manejar clics en los botones de la paleta
        colorOptions.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const selectedColor = btn.dataset.color;
                if (selectedColor) {
                    updateColor(selectedColor);
                }
            });
        });

        // Sincronizar textos de la vista previa
        const bindText = (input, target, formatter) => {
            if (!input || !target) return;
            input.addEventListener('input', () => {
                const v = input.value;
                target.textContent = formatter ? formatter(v) : (v || target.dataset.placeholder || target.textContent);
            });
        };

        bindText(bancoInput, bancoText);
        bindText(nombreInput, nombreText);
        bindText(limiteInput, limiteText, (v) => v ? `$${v}` : '$0.00');
        bindText(diaCorteInput, diaCorteText, (v) => v || '--');
    })();
</script>

{% endblock %}
